<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Writing Test â€” Corolla</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #FFFDF8;
    text-align: center;
    padding: 30px;
  }
  .card {
    background: white;
    max-width: 400px;
    margin: auto;
    padding: 20px;
    border-radius: 12px;
  }
  img {
    width: 200px;
    height: auto;
    margin-bottom: 10px;
  }
  input {
    padding: 8px;
    width: 200px;
    font-size: 16px;
    text-align: center;
  }
  button {
    margin-top: 10px;
    padding: 8px 16px;
    border: none;
    background: #FFD23F;
    border-radius: 8px;
    cursor: pointer;
  }
</style>
</head>

<body>

<div class="card">
  <h3>Look at the picture and type the word</h3>
  <img id="image" src="" alt="Question image">
  <br>
  <input type="text" id="answer" placeholder="Type here">
  <br>
  <button onclick="submitAnswer()">Submit</button>
</div>

<script>
/* ================= CONFIG ================= */

const API_URL = "http://localhost:8001/analyze-test3";
const NEXT_TEST_URL = "test4.html";

/* 5 fixed writing questions */
const QUESTIONS = [
  { img: "cat.png", answer: "cat", normalTime: 8000 },
  { img: "dog.png", answer: "dog", normalTime: 8000 },
  { img: "apple.png", answer: "apple", normalTime: 10000 },
  { img: "car.png", answer: "car", normalTime: 9000 },
  { img: "ball.png", answer: "ball", normalTime: 8000 }
];

/* ================= STATE ================= */

let index = 0;
let startTime = 0;
let firstKeyTime = null;
let results = [];

/* ================= ELEMENTS ================= */

const imageEl = document.getElementById("image");
const answerEl = document.getElementById("answer");

/* ================= FUNCTIONS ================= */

function showQuestion() {
  if (index >= QUESTIONS.length) {
    sendToAPI();
    document.body.innerHTML = "<h3>Test Completed ðŸŽ‰</h3>";
    return;
  }

  imageEl.src = QUESTIONS[index].img;
  answerEl.value = "";
  answerEl.focus();

  startTime = performance.now();
  firstKeyTime = null;
}

/* Detect first keystroke */
answerEl.addEventListener("input", () => {
  if (firstKeyTime === null) {
    firstKeyTime = Math.round(performance.now() - startTime);
  }
});

/* Submit answer */
function submitAnswer() {
  const userInput = answerEl.value.trim();
  const timeTaken = Math.round(performance.now() - startTime);

  results.push({
    question_image: QUESTIONS[index].img,
    user_input: userInput === "" ? null : userInput,
    correct_answer: QUESTIONS[index].answer,
    normal_time_ms: QUESTIONS[index].normalTime,
    first_keystroke_time_ms: firstKeyTime,
    user_time_ms: timeTaken
  });

  index++;
  showQuestion();
}

/* Send data to API */
function sendToAPI() {
  // Calculate metrics for writing/grammar test
  let totalWordsWritten = 0;
  let totalTime = 0;
  let spellingErrors = 0;
  
  results.forEach(result => {
    const words = result.user_input ? result.user_input.split(' ').length : 0;
    totalWordsWritten += words;
    totalTime += result.user_time_ms;
    if (result.user_input !== result.correct_answer) {
      spellingErrors++;
    }
  });

  const payload = {
    user_id: "user_" + Date.now(),
    test_id: "writing_test_1",
    text_written: results.map(r => r.user_input).join(" "),
    words_written: totalWordsWritten,
    total_words: results.length * 5, // Estimated total words
    writing_time_ms: totalTime,
    max_writing_time_ms: totalTime + 5000,
    spelling_errors: Math.min(spellingErrors, 20)
  };

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    console.log("API Response:", data);
    // Store results in localStorage instead of showing alert
    let allResults = JSON.parse(localStorage.getItem('testResults') || '{}');
    allResults.test3 = {
      type: "Grammar/Writing",
      array: data.array,
      timestamp: new Date().toISOString()
    };
    localStorage.setItem('testResults', JSON.stringify(allResults));
    window.location.href = NEXT_TEST_URL;
  })
  .catch(error => {
    console.error("Error:", error);
    window.location.href = NEXT_TEST_URL;
  });
}

/* Start test */
showQuestion();
</script>

</body>
</html>
