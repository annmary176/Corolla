<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Writing Test â€” Corolla</title>

<style>
  /* Modern Gradient Background */
  body {
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #e8e0ff 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    margin: 0;
    color: #4A4A68;
  }

  /* Shiny Rounded Square Card */
  .card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(12px);
    width: 380px;
    padding: 40px;
    border-radius: 32px; /* More pronounced rounded square */
    box-shadow: 0 20px 40px rgba(126, 87, 255, 0.1), 
                0 1px 3px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.7);
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  /* Shiny subtle overlay effect */
  .card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, transparent 70%);
    pointer-events: none;
  }

  h3 {
    font-weight: 700;
    letter-spacing: -0.5px;
    color: #6366f1;
    margin-bottom: 25px;
    font-size: 1.1rem;
    line-height: 1.3;
  }

  /* Image Container Styling */
  .image-box {
    background: #f8fafc;
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 25px;
    border: 1px solid #edf2f7;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  img {
    width: 180px;
    height: 180px;
    object-fit: contain;
    filter: drop-shadow(0 5px 15px rgba(0,0,0,0.08));
  }

  /* Clean Input Styling */
  input {
    padding: 14px;
    width: 220px;
    font-size: 1.1rem;
    text-align: center;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    background: white;
    transition: all 0.3s ease;
    outline: none;
    color: #4f46e5;
    font-weight: 600;
    margin-bottom: 10px;
  }

  input:focus {
    border-color: #818cf8;
    box-shadow: 0 0 0 4px rgba(129, 140, 248, 0.1);
  }

  /* Shiny Purple Button */
  button {
    margin-top: 15px;
    padding: 14px 30px;
    background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
    border: none;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    width: 100%;
  }

  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    filter: brightness(1.1);
  }

  button:active {
    transform: translateY(0);
  }

  /* Completion screen style */
  .completed {
    font-size: 1.5rem;
    font-weight: 700;
    color: #6366f1;
  }
</style>
</head>

<body>

<div class="card" id="test-container">
  <h3>Look at the picture and type the word</h3>
  <div class="image-box">
    <img id="image" src="" alt="Question image">
  </div>
  <input type="text" id="answer" placeholder="Type here..." autocomplete="off">
  <br>
  <button onclick="submitAnswer()">Submit</button>
</div>

<script>
/* ================= CONFIG (KEPT EXACTLY THE SAME) ================= */

const API_URL = "http://localhost:8001/analyze-test3";
const NEXT_TEST_URL = "test4.html";
const RESULTS_URL = "results.html";

/* 5 fixed writing questions */
const QUESTIONS = [
  { img: "cat.png", answer: "cat", normalTime: 8000 },
  { img: "dog.png", answer: "dog", normalTime: 8000 },
  { img: "apple.png", answer: "apple", normalTime: 10000 },
  { img: "car.png", answer: "car", normalTime: 9000 },
  { img: "ball.png", answer: "ball", normalTime: 8000 }
];

/* ================= STATE (KEPT EXACTLY THE SAME) ================= */

let index = 0;
let startTime = 0;
let firstKeyTime = null;
let results = [];

/* ================= ELEMENTS ================= */

const imageEl = document.getElementById("image");
const answerEl = document.getElementById("answer");
const containerEl = document.getElementById("test-container");

/* ================= FUNCTIONS ================= */

function showQuestion() {
  if (index >= QUESTIONS.length) {
    sendToAPI();
    containerEl.innerHTML = "<h3 class='completed'>Test Completed ðŸŽ‰</h3>";
    return;
  }

  imageEl.src = QUESTIONS[index].img;
  answerEl.value = "";
  answerEl.focus();

  startTime = performance.now();
  firstKeyTime = null;
}

/* Detect first keystroke */
answerEl.addEventListener("input", () => {
  if (firstKeyTime === null) {
    firstKeyTime = Math.round(performance.now() - startTime);
  }
});

/* Allow Enter key to submit */
answerEl.addEventListener("keypress", (e) => {
  if (e.key === "Enter") submitAnswer();
});

/* Submit answer */
function submitAnswer() {
  const userInput = answerEl.value.trim();
  const timeTaken = Math.round(performance.now() - startTime);

  results.push({
    question_image: QUESTIONS[index].img,
    user_input: userInput === "" ? null : userInput,
    correct_answer: QUESTIONS[index].answer,
    normal_time_ms: QUESTIONS[index].normalTime,
    first_keystroke_time_ms: firstKeyTime,
    user_time_ms: timeTaken
  });

  index++;
  showQuestion();
}

/* Send data to API (KEPT EXACTLY THE SAME) */
function sendToAPI() {
  let totalWordsWritten = 0;
  let totalTime = 0;
  let spellingErrors = 0;
  
  results.forEach(result => {
    const words = result.user_input ? result.user_input.split(' ').length : 0;
    totalWordsWritten += words;
    totalTime += result.user_time_ms;
    if (result.user_input !== result.correct_answer) {
      spellingErrors++;
    }
  });

  const payload = {
    user_id: "user_" + Date.now(),
    test_id: "writing_test_1",
    text_written: results.map(r => r.user_input).join(" "),
    words_written: totalWordsWritten,
    total_words: results.length * 5, 
    writing_time_ms: totalTime,
    max_writing_time_ms: totalTime + 5000,
    spelling_errors: Math.min(spellingErrors, 20)
  };

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    console.log("API Response:", data);
    let allResults = JSON.parse(localStorage.getItem('testResults') || '{}');
    allResults.test3 = {
      type: "Grammar/Writing",
      array: data.array,
      timestamp: new Date().toISOString()
    };
    localStorage.setItem('testResults', JSON.stringify(allResults));
    
    // Call petal prediction endpoint
    return fetch("http://localhost:5000/predict-writing", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ array: data.array || [0, 0, 0, 0] })
    });
  })
  .then(response => response.json())
  .then(petalData => {
    console.log("Petal Response:", petalData);
    // Store petal analysis results
    let allResults = JSON.parse(localStorage.getItem('testResults') || '{}');
    allResults.test3.petal = petalData;
    localStorage.setItem('testResults', JSON.stringify(allResults));
    
    // Store flower data
    let flowerData = JSON.parse(localStorage.getItem('flowerData') || '{}');
    flowerData.writing = petalData;
    localStorage.setItem('flowerData', JSON.stringify(flowerData));
    
    // Save progress to roadmap
    const progress = JSON.parse(localStorage.getItem('roadmapProgress') || '{}');
    progress.completedLevels = progress.completedLevels || [];
    if (!progress.completedLevels.includes(3)) {
      progress.completedLevels.push(3);
    }
    progress.currentLevel = 4;
    progress.lastUpdated = new Date().toISOString();
    localStorage.setItem('roadmapProgress', JSON.stringify(progress));
    
    // Always go to next test
    window.location.href = NEXT_TEST_URL;
  })
  .catch(error => {
    console.error("Error:", error);
    window.location.href = NEXT_TEST_URL;
  });
}

/* Start test */
showQuestion();
</script>

</body>
</html>