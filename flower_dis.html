<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Results - Parent Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f8f9ff 0%, #e0e7ff 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; overflow-x: hidden; }
        
        /* Layout Containers */
        .login-container { background: white; border-radius: 24px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); padding: 40px; max-width: 400px; width: 100%; text-align: center; }
        .results-container { background: white; border-radius: 24px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); padding: 40px; max-width: 900px; width: 100%; display: none; }
        .results-container.show { display: block; }

        /* Flower Overlay View */
        #flowerView { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }

        h1 { color: #6366f1; margin-bottom: 20px; font-size: 1.8em; }
        
        /* Buttons */
        .primary-btn { width: 100%; padding: 14px; background: #6366f1; color: white; border: none; border-radius: 12px; font-size: 1em; font-weight: 600; cursor: pointer; transition: 0.3s; margin-bottom: 10px; }
        .primary-btn:hover { background: #4f46e5; transform: translateY(-2px); }
        .petal-view-btn { background: linear-gradient(135deg, #f472b6, #db2777); margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .back-btn { background: #94a3b8; width: auto; padding: 10px 20px; position: absolute; top: 20px; left: 20px; z-index: 1100; }

        /* Flower CSS */
        .flower-container { position: relative; width: 400px; height: 400px; display: flex; align-items: center; justify-content: center; }
        .center-piece { width: 100px; height: 100px; background: radial-gradient(circle at 30% 30%, #ffeb99, #FFD23F); border-radius: 50%; z-index: 30; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 800; color: #744210; box-shadow: 0 0 30px rgba(255, 210, 63, 0.6); border: 6px solid white; }
        
        .petal { position: absolute; width: 140px; height: 190px; border-radius: 50% 50% 50% 50% / 70% 70% 30% 30%; border: 2px solid rgba(255,255,255,0.9); transform-origin: bottom center; bottom: 50%; left: calc(50% - 70px); z-index: 10; overflow: hidden; animation: petalWave 4s ease-in-out infinite; transition: all 1.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Shiny gloss effect on petals */
        .petal::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(110deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 30%, rgba(255,255,255,0.2) 60%, rgba(255,255,255,0) 100%); pointer-events: none; }

        @keyframes petalWave { 0%, 100% { transform: rotate(var(--rot)) scale(1); } 50% { transform: rotate(calc(var(--rot) + 3deg)) scale(1.03); } }

        .petal-content { transform: rotate(calc(var(--rot) * -1)); text-align: center; color: white; font-weight: bold; padding-top: 20px; }
        .petal-value { background: rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 4px; display: inline-block; }

        /* Standard Result Styles */
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .test-card { background: #f8fafc; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; }
        .metric-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #edf2f7; }
        .metric-value { background: #6366f1; color: white; padding: 4px 10px; border-radius: 6px; font-weight: bold; font-size: 0.85rem; }

        .form-group { text-align: left; margin-bottom: 15px; }
        input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; }
        #errorNotice { display: none; color: #ef4444; font-size: 0.8rem; margin-top: 10px; background: #fee2e2; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

    <!-- Login Section -->
    <div class="login-container" id="loginContainer">
        <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Portal</h1>
        <div class="form-group">
            <input type="password" id="password" placeholder="Enter parent password">
        </div>
        <button class="primary-btn" onclick="login()">Login</button>
        <p style="font-size: 0.8rem; color: #94a3b8;">Default: parent123</p>
    </div>

    <!-- Results Table Section -->
    <div class="results-container" id="resultsContainer">
        <h1>üìä Performance Summary</h1>
        <div id="resultsContent"></div>
        
        <button class="primary-btn petal-view-btn" onclick="openFlowerView()">
            üå∏ View as Cognitive Flower
        </button>
        <div id="errorNotice">Note: Backend offline. Showing estimated profile based on scores.</div>
        
        <button class="primary-btn" style="background:#94a3b8; margin-top:40px" onclick="logout()">Logout</button>
    </div>

    <!-- Waving Flower Top-View Section -->
    <div id="flowerView">
        <button class="primary-btn back-btn" onclick="closeFlowerView()">‚Üê Back to List</button>
        <h2 id="flower-title" style="margin-bottom: 40px; color: #4338ca;">Profile Growth</h2>
        
        <div class="flower-container">
            <div class="center-piece">
                <span id="center-score">--</span>
                <span style="font-size: 0.6rem;">AVG SCORE</span>
            </div>
            
            <div id="p-dyslexia" class="petal" style="--rot: 0deg; background: #6366f1;">
                <div class="petal-content"><div class="petal-value" id="v-dyslexia">--</div><br>Dyslexia</div>
            </div>
            <div id="p-dyscalculia" class="petal" style="--rot: 90deg; background: #6366f1;">
                <div class="petal-content"><div class="petal-value" id="v-dyscalculia">--</div><br>Dyscalculia</div>
            </div>
            <div id="p-dysgraphia" class="petal" style="--rot: 180deg; background: #6366f1;">
                <div class="petal-content"><div class="petal-value" id="v-dysgraphia">--</div><br>Dysgraphia</div>
            </div>
            <div id="p-adhd" class="petal" style="--rot: 270deg; background: #6366f1;">
                <div class="petal-content"><div class="petal-value" id="v-adhd">--</div><br>ADHD</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:8001/predict-results";

        function login() {
            if (document.getElementById('password').value === 'parent123') {
                sessionStorage.setItem('parentLoggedIn', 'true');
                showResults();
            }
        }

        function showResults() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('resultsContainer').classList.add('show');
            const data = JSON.parse(localStorage.getItem('testResults') || '{}');
            let html = '<div class="results-grid">';
            
            const keys = Object.keys(data);
            if (keys.length === 0) {
                html = '<p style="grid-column: 1/-1; color: #94a3b8;">No test results found yet. Complete a test first.</p>';
            } else {
                keys.forEach(key => {
                    const test = data[key];
                    html += `
                        <div class="test-card">
                            <h3>${test.type} Analysis</h3>
                            <div class="metric-row"><span>Accuracy</span><span class="metric-value">${test.array[0]}%</span></div>
                            <div class="metric-row"><span>Speed</span><span class="metric-value">${test.array[1]}s</span></div>
                        </div>
                    `;
                });
            }
            html += '</div>';
            document.getElementById('resultsContent').innerHTML = html;
        }

        async function openFlowerView() {
            document.getElementById('flowerView').style.display = 'flex';
            document.getElementById('errorNotice').style.display = 'none';
            
            // Get data from localStorage (passed from results.html)
            const flowerData = JSON.parse(localStorage.getItem('flowerData') || '{}');
            const testResults = JSON.parse(localStorage.getItem('testResults') || '{}');
            
            // Collect features from test results
            const features = {
                reading_score: flowerData.test1 && flowerData.test1.array ? flowerData.test1.array[0] * 100 : 70,
                logic_score: flowerData.test2 && flowerData.test2.array ? flowerData.test2.array[0] * 100 : 65,
                writing_score: flowerData.test3 && flowerData.test3.array ? flowerData.test3.array[0] * 100 : 40,
                memory_score: flowerData.test4 && flowerData.test4.longestSequence ? (flowerData.test4.longestSequence / 5) * 100 : 80,
                reading_time: flowerData.test1 && flowerData.test1.array ? flowerData.test1.array[1] * 1000 : 10000,
                logic_time: flowerData.test2 && flowerData.test2.array ? flowerData.test2.array[1] * 1000 : 12000,
                writing_time: flowerData.test3 && flowerData.test3.array ? flowerData.test3.array[1] * 1000 : 20000,
                memory_time: flowerData.test4 && flowerData.test4.array ? flowerData.test4.array[1] * 1000 : 8000
            };

            // Ensure scores are within 0-100
            Object.keys(features).forEach(key => {
                if (key.includes('_score')) {
                    features[key] = Math.max(0, Math.min(100, features[key]));
                }
            });

            const renderFlower = (result) => {
                const overallScore = (features.reading_score + features.logic_score + features.writing_score + features.memory_score) / 4;
                document.getElementById('center-score').innerText = Math.round(overallScore) + "%";
                
                const performanceLevel = overallScore > 75 ? "üåü Excellent" : 
                                       overallScore > 50 ? "üëç Good" : 
                                       overallScore > 25 ? "üìö Average" : "üí™ Developing";
                document.getElementById('flower-title').innerText = performanceLevel + " Performance Profile";

                const updatePetal = (id, val) => {
                    const p = document.getElementById('p-' + id);
                    const v = document.getElementById('v-' + id);
                    v.innerText = Math.round(val) + "%";
                    // Map score to petal height (Min 140, Max 220)
                    p.style.height = (140 + (val * 0.8)) + "px";
                    // Color coding based on performance
                    if (val > 70) {
                        p.style.background = 'linear-gradient(135deg, #86efac, #22c55e)';
                    } else if (val > 40) {
                        p.style.background = 'linear-gradient(135deg, #fca5a5, #f472b6)';
                    } else {
                        p.style.background = 'linear-gradient(135deg, #c7d2fe, #6366f1)';
                    }
                };

                updatePetal('dyslexia', features.reading_score);
                updatePetal('dyscalculia', features.logic_score);
                updatePetal('dysgraphia', features.writing_score);
                updatePetal('adhd', features.memory_score);
            };

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(features)
                });
                
                if (!res.ok) throw new Error("API response error");
                
                const result = await res.json();
                renderFlower(result);
            } catch (e) {
                console.warn("Backend fetch failed, using internal logic fallback:", e);
                document.getElementById('errorNotice').style.display = 'block';
                renderFlower({});
            }
        }

        function closeFlowerView() { 
            document.getElementById('flowerView').style.display = 'none'; 
        }

        function goBackToResults() {
            window.location.href = 'results.html';
        }

        function logout() { 
            sessionStorage.removeItem('parentLoggedIn');
            localStorage.removeItem('flowerData');
            location.reload(); 
        }

        // Initial check
        window.onload = () => {
            if (sessionStorage.getItem('parentLoggedIn') === 'true') {
                showResults();
            }
        };
    </script>
</body>
</html>